# 基于 Spring Cloud Gateway 的网关微服务

## 一、项目简介

本项目是一个基于 **Spring Cloud Gateway** 的网关微服务，旨在为分布式微服务架构提供统一的入口层。  
网关负责处理外部请求的接入、路由转发、负载均衡、安全认证与授权、流量控制以及日志与链路追踪等核心功能。

通过该网关，可以：

- 将后端多个微服务统一暴露为一个对外入口，屏蔽底层服务的复杂性；
- 对外提供统一的认证授权和安全防护能力；
- 实现对流量的集中管控（限流、熔断、降级）；
- 统一采集日志和调用链路，便于监控与故障排查；
- 支持分布式多实例部署，提升系统整体的高可用性与可扩展性。

## 二、功能说明

### 1. 用户认证

- 基于 **Spring Security** 集成认证逻辑；
- 支持基于 **JWT** 的无状态认证，也可与 OAuth2 / OpenID Connect 认证中心集成；
- 在网关层完成登录态/令牌校验，减少各业务服务对认证逻辑的重复实现；
- 从请求头、Cookie 或 Query 参数中解析并验证令牌，校验通过后将用户信息透传给下游服务。

### 2. 用户授权

- 依托 Spring Security 实现细粒度授权控制；
- 支持基于 **角色（Role）** 和 **权限（Authority）** 的访问控制；
- 可针对不同路由（API 路径、HTTP 方法）配置访问策略；
- 对未授权的请求，以统一格式返回 HTTP 401 / 403 等错误响应。

### 3. 请求路由与转发

- 使用 **Spring Cloud Gateway** 作为网关核心组件；
- 支持基于：
  - 服务名（结合注册中心，如 Nacos / Eureka 等）；
  - 具体 URL / Host / Path / Header / Query 参数
  的多条件路由；
- 支持路由过滤器（GatewayFilter）：
  - 路径重写（Path Rewrite）；
  - 请求头、请求参数增强或移除；
  - 自定义过滤器链（鉴权、灰度发布、统一日志等）；
- 路由规则支持从配置文件或配置中心动态加载。

### 4. 日志采集与链路追踪

- 对所有进入网关的请求进行访问日志记录，包括：
  - 请求路径、请求方法、请求头（脱敏后）；
  - 响应状态码、响应时间、调用链路标识等；
- 兼容 **OpenTracing** 协议（可扩展为 OpenTelemetry），支持与 Jaeger、Zipkin 等链路追踪系统集成；
- 可集成 **Spring Cloud Sleuth**，在请求进入网关时创建或继续传播 TraceId / SpanId，实现端到端调用链追踪；
- 支持结构化日志输出，方便接入 ELK / Loki 等日志系统。

### 5. 限流功能

- 基于 Spring Cloud Gateway 的 **RateLimiter**（如 RedisRateLimiter）组件实现限流；
- 支持按：
  - IP、用户 ID、
  - 客户端 ID、接口路径等维度进行限流；
- 支持令牌桶、固定窗口等限流策略（根据具体实现）；
- 使用 Redis 等中间件实现分布式环境下的统一限流；
- 被限流请求统一返回标准错误码和错误信息，支持自定义响应格式。

### 6. 负载均衡功能

- 结合 Spring Cloud 生态的 **Spring Cloud LoadBalancer**（或 Ribbon 等）实现客户端负载均衡；
- 网关侧根据服务名从注册中心获取服务实例列表，并按策略选择目标实例；
- 支持多种负载均衡策略：轮询、随机、权重等；
- 对异常实例可进行剔除或降级处理，提升整体可用性。

### 7. 熔断与降级功能

- 可结合 **Resilience4j** 等组件，为网关路由调用增加熔断、限流、隔离舱等容错能力；
- 配置熔断阈值（错误率、连续失败次数）、超时时间、半开恢复策略等参数；
- 后端服务不可用或调用超时时，网关快速失败并返回预设的降级响应；
- 提供统一的异常与降级处理机制，避免异常扩散到前端用户。

### 8. 分布式多实例部署

- 网关本身支持无状态化设计，方便进行多实例横向扩展；
- 可在 **Kubernetes / Docker** 等容器平台上部署，实现弹性伸缩；
- 配合 Nginx 或云负载均衡，对网关实例进行流量分发；
- 与注册中心、配置中心集成，实现服务自动发现与配置热更新。

## 三、技术栈

### 1. 核心框架

- **Spring Boot**
  - 作为基础应用框架，提供自动配置与运行时容器；
  - 统一应用日志、配置、监控端点（Actuator）等基础能力。

- **Spring Cloud & Spring Cloud Gateway**
  - Spring Cloud：提供微服务治理能力（注册、发现、配置、容错等）；
  - Spring Cloud Gateway：作为网关实现路由、过滤、限流等功能；
  - 使用 Reactor 模型实现响应式编程，具备更好的性能与扩展性。

### 2. 安全与认证

- **Spring Security**
  - 提供统一的认证与授权框架；
  - 支持与 OAuth2 / OpenID Connect 集成，支持 JWT 等多种令牌格式；
  - 在网关侧集中处理安全逻辑，对后端服务透明。

- **JWT / OAuth2（可选）**
  - 用于实现无状态会话与单点登录（SSO）；
  - 支持将用户身份和权限信息编码在令牌中，便于跨服务传递。

### 3. 注册中心与配置中心（根据实际选型）

- 注册中心（至少一种）：
  - **Nacos / Eureka / Consul**  
  - 提供服务注册与发现能力，Gateway 通过服务名发现后端服务。

- 配置中心（至少一种）：
  - **Spring Cloud Config / Nacos / Apollo**  
  - 实现网关路由规则、安全策略、限流规则等的集中配置与动态刷新。

### 4. 日志、监控与链路追踪

- 日志：
  - **SLF4J + Logback**；
  - 支持 JSON/结构化日志输出，便于对接日志平台（ELK、Loki 等）。

- 链路追踪：
  - **Spring Cloud Sleuth + Zipkin / Jaeger / OpenTelemetry**；
  - 在调用链路中自动注入 TraceId、SpanId。

- 监控：
  - **Spring Boot Actuator** 暴露健康检查、指标数据；
  - 可配合 **Prometheus + Grafana** 实现系统运行状态可视���。

### 5. 中间件与基础设施

- **Redis**
  - 用于分布式限流计数、黑白名单、缓存等；
- 数据库（可选）
  - 若网关需要持久化配置信息、API 元数据等，可引入 MySQL / PostgreSQL 等数据库；
- 部署环境：
  - **Docker / Kubernetes**；
  - 外层可接入 Nginx 或云负载均衡作为统一入口。

## 四、适用场景

- 需要统一出口的微服务系统，希望将认证、授权、限流、熔断等能力集中到网关；
- 希望通过 Spring Cloud Gateway 提供响应式、高性能 API 网关能力；
- 已经使用 Spring Cloud 体系（Eureka / Nacos + Config 等）的现有系统；
- 需要接入链路追踪、集中日志与监控平台的分布式系统。